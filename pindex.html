<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#eff6ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3757/3757753.png">
    
    <title>æˆ‘çš„å¤§ç®¡å®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <script>
        // PWA Service Worker æ³¨å†Œé€»è¾‘ (æ–°å¢)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('PWA Registered'))
                    .catch(err => console.log('PWA Error', err));
            });
        }

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'PingFang SC', 'Segoe UI', 'sans-serif'] },
                    colors: {
                        tech: { 
                            bg: '#eef6ff',
                            surface: 'rgba(255, 255, 255, 0.65)', 
                            border: 'rgba(255, 255, 255, 0.9)',
                            text: '#0f172a',
                            blue: '#2563eb'
                        }
                    },
                    animation: { 'float': 'float 6s ease-in-out infinite', 'slide-up': 'slideUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1)' },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        slideUp: { '0%': { transform: 'translateY(40px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: linear-gradient(135deg, #f0f7ff 0%, #e0efff 50%, #f5faff 100%);
            background-attachment: fixed;
        }
        .glass-panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.7) 0%, rgba(255,255,255,0.4) 100%);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255, 0.8);
            box-shadow: 
                0 4px 6px -1px rgba(59, 130, 246, 0.05), 
                0 2px 4px -1px rgba(59, 130, 246, 0.03),
                inset 0 0 20px rgba(255,255,255, 0.5);
        }
        .sphere-card {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.95) 0%, rgba(219, 234, 254, 0.85) 60%, rgba(191, 219, 254, 0.8) 100%);
            border: 1px solid rgba(255,255,255, 0.9);
            box-shadow: 
                0 20px 40px -10px rgba(37, 99, 235, 0.15),
                inset 0 0 40px rgba(255,255,255, 0.8);
            position: relative;
            overflow: hidden;
        }
        .sphere-ring {
            position: absolute; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5);
            top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input, select, textarea { -webkit-appearance: none; outline: none; }
        .active-press:active { transform: scale(0.97); transition: transform 0.1s; }
        .img-upload-box {
            background-image: url("data:image/svg+xml,%3csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='none' rx='16' ry='16' stroke='%2393C5FD' stroke-width='1.5' stroke-dasharray='6%2c 10' stroke-dashoffset='0' stroke-linecap='square'/%3e%3c/svg%3e");
            transition: all 0.3s;
        }
        .img-upload-box.has-img { background: none; border: none; }
    </style>
</head>
<body class="text-slate-800 pb-28 antialiased selection:bg-blue-200 selection:text-blue-900">

    <div class="fixed top-0 left-0 right-0 z-40 px-6 pt-12 pb-4 flex justify-between items-center bg-white/40 backdrop-blur-xl border-b border-white/40">
        <div>
            <div class="text-[10px] font-bold text-blue-500/80 uppercase tracking-widest mb-0.5" id="header-date">...</div>
            <h1 class="text-2xl font-bold tracking-tight text-slate-800">æˆ‘çš„å¤§ç®¡å®¶</h1>
        </div>
        <button onclick="app.openSystemModal()" class="w-10 h-10 rounded-full bg-white/60 hover:bg-white/80 backdrop-blur-md flex items-center justify-center shadow-sm border border-white/60 transition-all group">
            <i class="ph-fill ph-gear text-xl text-slate-400 group-hover:text-blue-500 group-hover:rotate-90 transition-all"></i>
        </button>
    </div>

    <div id="view-tobuy" class="view min-h-screen flex flex-col pt-[100px]">
        <div class="banner-container flex overflow-x-auto snap-x snap-mandatory gap-5 px-6 pb-8 pt-4 no-scrollbar" id="banner-scroll" onscroll="app.updateBannerDots()">
            
            <div class="sphere-card flex-none w-full snap-center rounded-[32px] p-8 animate-float">
                <div class="sphere-ring w-[120%] h-[120%]"></div>
                <div class="sphere-ring w-[80%] h-[80%] opacity-50"></div>
                <div class="relative z-10 flex flex-col items-center text-center">
                    <div class="text-xs font-semibold text-blue-900/50 uppercase tracking-widest mb-2">å¾…è´­é¢„ä¼°æ€»é¢</div>
                    <div class="text-5xl font-bold font-sans text-blue-900 mb-6 tracking-tight drop-shadow-sm">Â¥<span id="total-expected-cost">0</span></div>
                    <div class="flex items-center gap-2 text-xs font-semibold bg-white/40 px-4 py-2 rounded-full border border-white/60 backdrop-blur-sm shadow-sm">
                        <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                        <span class="text-slate-600">é¢„ç®—å‰©ä½™: <span id="budget-left" class="text-blue-600">è®¡ç®—ä¸­...</span></span>
                    </div>
                </div>
            </div>

            <div class="glass-panel flex-none w-full snap-center rounded-[32px] p-6 relative flex flex-col justify-center">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 px-1 flex justify-between items-center">
                    <span>æ¸…å•æ„æˆ</span>
                    <i class="ph-fill ph-chart-pie-slice text-blue-300"></i>
                </div>
                <div id="banner-category-chart" class="space-y-4 px-1">
                    <div class="text-center text-slate-300 text-xs py-2">æš‚æ— æ•°æ®</div>
                </div>
            </div>

            <div class="glass-panel flex-none w-full snap-center rounded-[32px] p-6 flex flex-col justify-center">
                <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 px-2 flex justify-between items-center">
                    <span>ä¼˜å…ˆçº§çŸ©é˜µ</span>
                    <i class="ph-fill ph-flag text-blue-300"></i>
                </div>
                <div class="flex justify-between items-end px-4">
                    <div class="text-center group"><div class="text-3xl font-bold text-red-500 mb-2 transition-transform group-hover:-translate-y-1" id="count-p1">0</div><div class="text-[10px] font-bold text-slate-400">åˆšéœ€</div></div>
                    <div class="w-px h-10 bg-gradient-to-b from-transparent via-blue-200 to-transparent"></div>
                    <div class="text-center group"><div class="text-3xl font-bold text-amber-500 mb-2 transition-transform group-hover:-translate-y-1" id="count-p2">0</div><div class="text-[10px] font-bold text-slate-400">æ”¹å–„</div></div>
                    <div class="w-px h-10 bg-gradient-to-b from-transparent via-blue-200 to-transparent"></div>
                    <div class="text-center group"><div class="text-3xl font-bold text-emerald-500 mb-2 transition-transform group-hover:-translate-y-1" id="count-p3">0</div><div class="text-[10px] font-bold text-slate-400">è£…é¥°</div></div>
                </div>
            </div>
        </div>
        
        <div class="flex justify-center gap-2 mb-6">
            <div class="dot w-1.5 h-1.5 rounded-full bg-blue-400 transition-all duration-300"></div>
            <div class="dot w-1.5 h-1.5 rounded-full bg-blue-200 transition-all duration-300"></div>
            <div class="dot w-1.5 h-1.5 rounded-full bg-blue-200 transition-all duration-300"></div>
        </div>

        <div class="px-6 mb-4 sticky top-[90px] z-30">
            <div class="flex gap-3">
                <div class="relative flex-1 group">
                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none"><i class="ph ph-magnifying-glass text-blue-300 text-lg"></i></div>
                    <input type="text" id="search-input" placeholder="æœç´¢ç‰©å“..." oninput="app.renderToBuy()" class="block w-full pl-11 pr-4 py-3.5 bg-white/70 backdrop-blur-xl border border-white/80 rounded-2xl text-sm font-medium shadow-sm focus:bg-white focus:ring-2 focus:ring-blue-100 transition-all placeholder-slate-400 text-slate-700">
                </div>
                <div class="relative">
                    <select id="sort-mode" onchange="app.renderToBuy()" class="h-full appearance-none bg-white/70 backdrop-blur-xl border border-white/80 text-slate-600 font-bold text-xs py-2 pl-5 pr-10 rounded-2xl shadow-sm focus:bg-white focus:ring-2 focus:ring-blue-100 uppercase tracking-wide">
                        <option value="priority">æŒ‰ä¼˜å…ˆçº§</option><option value="date">æŒ‰æ—¥æœŸ</option><option value="category">æŒ‰åˆ†ç±»</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-blue-300"><i class="ph-bold ph-caret-down text-xs"></i></div>
                </div>
            </div>
        </div>

        <div class="flex-1 px-6">
            <div id="tobuy-list" class="space-y-3 pb-6"></div>
            <div id="empty-state" class="hidden flex-col items-center justify-center py-16 opacity-50">
                <div class="w-16 h-16 rounded-full bg-white/50 flex items-center justify-center mb-4 border border-white/60 shadow-sm"><i class="ph ph-check text-3xl text-blue-300"></i></div>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">æ¸…å•å·²æ¸…ç©º</p>
            </div>
        </div>

        <button onclick="app.openAddModal()" class="fixed bottom-28 right-6 w-14 h-14 rounded-full bg-gradient-to-tr from-blue-600 to-blue-400 text-white flex items-center justify-center shadow-lg shadow-blue-500/30 z-30 active:scale-90 transition-transform duration-200 group border border-white/20">
            <i class="ph-bold ph-plus text-2xl group-hover:rotate-90 transition-transform"></i>
        </button>
    </div>

    <div id="view-purchased" class="view hidden min-h-screen px-6 pt-[110px]">
        <div class="glass-panel rounded-[20px] p-2 mb-6 flex relative items-center">
            <i class="ph ph-magnifying-glass absolute left-4 text-blue-300"></i>
            <input type="text" id="pur-search-input" placeholder="æœç´¢å·²è´­è®°å½•..." oninput="app.renderPurchased()" class="w-full pl-10 bg-transparent py-2 text-sm text-slate-600 font-medium">
        </div>
        <div id="purchased-list" class="space-y-3 pb-6"></div>
    </div>

    <div id="view-stats" class="view hidden min-h-screen px-6 pt-[110px]">
        <div class="bg-white/40 p-1 rounded-xl flex mb-6 relative backdrop-blur-md border border-white/40">
            <div class="w-full flex">
                <div class="stat-tab flex-1 py-2 text-[10px] font-bold uppercase tracking-wider text-center rounded-lg cursor-pointer text-slate-400 transition-all" onclick="app.switchStatMode('week', this)">æœ¬å‘¨</div>
                <div class="stat-tab flex-1 py-2 text-[10px] font-bold uppercase tracking-wider text-center rounded-lg cursor-pointer bg-white text-blue-600 shadow-sm" onclick="app.switchStatMode('month', this)">æœ¬æœˆ</div>
                <div class="stat-tab flex-1 py-2 text-[10px] font-bold uppercase tracking-wider text-center rounded-lg cursor-pointer text-slate-400 transition-all" onclick="app.switchStatMode('year', this)">ä»Šå¹´</div>
            </div>
        </div>
        <div class="glass-panel rounded-[32px] p-8 shadow-sm mb-5 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-300 via-blue-500 to-blue-300 opacity-50"></div>
            <div class="flex justify-center items-center gap-4 mb-2">
                <button onclick="app.changeStatDate(-1)" class="w-8 h-8 rounded-full bg-white/50 hover:bg-white flex items-center justify-center text-blue-500 transition-colors"><i class="ph-bold ph-caret-left"></i></button>
                <span id="stat-date-display" class="font-bold text-lg tabular-nums text-slate-700">---</span>
                <button onclick="app.changeStatDate(1)" class="w-8 h-8 rounded-full bg-white/50 hover:bg-white flex items-center justify-center text-blue-500 transition-colors"><i class="ph-bold ph-caret-right"></i></button>
            </div>
            <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">æœŸé—´æ€»æ”¯å‡º</div>
            <div class="text-4xl font-bold text-slate-800 tracking-tight">Â¥<span id="stat-total">0</span></div>
        </div>
        <div class="glass-panel rounded-[24px] p-6 shadow-sm mb-5">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-5 tracking-widest flex items-center gap-2"><i class="ph-fill ph-chart-pie-slice"></i> åˆ†ç±»æ„æˆ</h3>
            <div id="css-chart-area" class="space-y-4"></div>
        </div>
        <div class="glass-panel rounded-[24px] p-6 shadow-sm">
            <h3 class="text-[10px] font-bold text-slate-400 uppercase mb-5 tracking-widest flex items-center gap-2"><i class="ph-fill ph-target"></i> é¢„ç®—ç›‘æ§</h3>
            <div id="budget-display-area"></div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full h-[88px] bg-white/60 backdrop-blur-xl border-t border-white/40 flex justify-around items-start pt-3 z-50 pb-safe">
        <div class="nav-item group cursor-pointer flex flex-col items-center gap-1 w-16 active-press" onclick="app.switchTab('tobuy', this)">
            <i class="ph-fill ph-circles-four text-2xl text-blue-600 transition-colors drop-shadow-sm"></i><span class="text-[10px] font-bold text-blue-600">æ¸…å•</span>
        </div>
        <div class="nav-item group cursor-pointer flex flex-col items-center gap-1 w-16 active-press" onclick="app.switchTab('purchased', this)">
            <i class="ph ph-package text-2xl text-slate-400 transition-colors"></i><span class="text-[10px] font-bold text-slate-400">åº“æˆ¿</span>
        </div>
        <div class="nav-item group cursor-pointer flex flex-col items-center gap-1 w-16 active-press" onclick="app.switchTab('stats', this)">
            <i class="ph ph-chart-bar text-2xl text-slate-400 transition-colors"></i><span class="text-[10px] font-bold text-slate-400">æ´å¯Ÿ</span>
        </div>
    </nav>

    <div id="modal-item" class="modal fixed inset-0 z-[100] hidden items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/10 backdrop-blur-sm transition-opacity" onclick="app.closeModal('modal-item')"></div>
        <div class="glass-panel w-full sm:w-[450px] rounded-t-[32px] sm:rounded-[32px] p-8 animate-slide-up relative z-10 max-h-[92vh] overflow-y-auto no-scrollbar shadow-2xl border-t border-white/80 bg-white/80">
            <div class="w-12 h-1 bg-slate-300/50 rounded-full mx-auto mb-8"></div>
            <h3 id="modal-title" class="text-xl font-bold mb-6 text-center text-slate-800">æ·»åŠ ç‰©å“</h3>
            <input type="hidden" id="item-id">
            
            <div class="space-y-5">
                <div class="flex gap-5">
                    <div class="w-24 h-24 shrink-0 img-upload-box rounded-[20px] flex items-center justify-center cursor-pointer relative overflow-hidden group bg-blue-50/50 hover:bg-white transition-all border border-blue-100" onclick="document.getElementById('item-img-file').click()">
                        <input type="file" id="item-img-file" hidden accept="image/*" onchange="app.handleImageUpload(this)">
                        <input type="hidden" id="item-img-base64">
                        <img id="item-img-preview" class="w-full h-full object-cover hidden">
                        <i id="item-img-placeholder" class="ph ph-camera text-2xl text-blue-300"></i>
                    </div>
                    <div class="flex-1 space-y-4">
                        <input type="text" id="item-name" placeholder="ç‰©å“åç§°" onblur="app.autoCategorizeInput()" class="w-full bg-white/60 p-3.5 rounded-[18px] text-lg font-bold border border-white/60 focus:bg-white focus:border-blue-200 focus:shadow-sm h-[50px] text-slate-800 placeholder-slate-400 transition-all">
                        <input type="number" id="item-price" placeholder="Â¥ é¢„ä¼°ä»·æ ¼" class="w-full bg-white/60 p-3.5 rounded-[18px] font-bold border border-white/60 focus:bg-white focus:border-blue-200 focus:shadow-sm text-slate-800 placeholder-slate-400 transition-all">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/40 p-3 rounded-[20px] border border-white/60">
                       <label class="block text-[9px] font-bold text-slate-400 ml-1 mb-1.5 uppercase tracking-wider">ä¼˜å…ˆçº§</label>
                       <select id="item-priority" class="w-full bg-transparent font-bold text-sm text-slate-700"><option value="1">ğŸ”´ åˆšéœ€</option><option value="2" selected>ğŸŸ¡ æ”¹å–„</option><option value="3">ğŸŸ¢ è£…é¥°</option></select>
                    </div>
                    <div class="bg-white/40 p-3 rounded-[20px] border border-white/60">
                       <label class="block text-[9px] font-bold text-slate-400 ml-1 mb-1.5 uppercase tracking-wider">è´­ä¹°å¹³å°</label>
                       <select id="item-platform" class="w-full bg-transparent font-bold text-sm text-slate-700"><option value="æ·˜å®">æ·˜å®</option><option value="äº¬ä¸œ">äº¬ä¸œ</option><option value="æ‹¼å¤šå¤š">æ‹¼å¤šå¤š</option><option value="çº¿ä¸‹">çº¿ä¸‹</option><option value="å…¶ä»–">å…¶ä»–</option></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/40 p-3 rounded-[20px] border border-white/60">
                       <label class="block text-[9px] font-bold text-slate-400 ml-1 mb-1.5 uppercase tracking-wider">ä¸»åˆ†ç±»</label>
                       <select id="item-category" onchange="app.updateSubCategories()" class="w-full bg-transparent font-bold text-sm text-slate-700"></select>
                    </div>
                    <div class="bg-white/40 p-3 rounded-[20px] border border-white/60">
                       <label class="block text-[9px] font-bold text-slate-400 ml-1 mb-1.5 uppercase tracking-wider">å­åˆ†ç±»</label>
                       <input list="sub-options" id="item-subcategory" class="w-full bg-transparent font-bold text-sm placeholder-slate-300 text-slate-700" placeholder="è¾“å…¥æˆ–é€‰æ‹©...">
                       <datalist id="sub-options"></datalist>
                    </div>
                </div>

                <div class="bg-white/40 p-4 rounded-[20px] border border-white/60 space-y-3">
                    <div class="flex items-center border-b border-slate-200/50 pb-2">
                        <i class="ph ph-link text-slate-400 mr-3 text-lg"></i>
                        <input type="url" id="item-link" placeholder="ç²˜è´´é“¾æ¥" class="w-full text-sm bg-transparent text-blue-600 font-medium placeholder-slate-400">
                    </div>
                    <div class="flex items-start pt-1">
                        <i class="ph ph-text-align-left text-slate-400 mr-3 mt-1 text-lg"></i>
                        <textarea id="item-note" rows="2" placeholder="å¤‡æ³¨ï¼ˆè§„æ ¼ã€é¢œè‰²ã€ä¿ƒé”€...ï¼‰" class="w-full text-sm bg-transparent resize-none text-slate-600 font-medium placeholder-slate-400"></textarea>
                    </div>
                </div>

                <div class="bg-white/40 p-3 rounded-[20px] border border-white/60">
                   <label class="block text-[9px] font-bold text-slate-400 ml-1 mb-1.5 uppercase tracking-wider">æˆªæ­¢æ—¥æœŸ</label>
                   <input type="date" id="item-deadline" class="w-full bg-transparent text-sm font-bold text-slate-700">
                </div>

                <div class="flex flex-col gap-3 mt-4">
                    <div class="flex gap-3">
                        <button onclick="app.saveItem()" class="flex-1 bg-blue-600 text-white font-bold py-4 rounded-[18px] shadow-lg shadow-blue-500/20 active:scale-95 transition-all">ä¿å­˜ç‰©å“</button>
                        <button onclick="app.closeModal('modal-item')" class="flex-1 bg-white text-slate-600 font-bold py-4 rounded-[18px] active:scale-95 transition-all hover:bg-slate-50 border border-slate-200">å–æ¶ˆ</button>
                    </div>
                    <button id="btn-delete-item" onclick="app.deleteCurrentItem()" class="w-full text-red-400 font-bold py-3 text-xs hover:text-red-600 hidden">åˆ é™¤æ­¤ç‰©å“</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-system" class="modal fixed inset-0 z-[100] hidden items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/10 backdrop-blur-sm" onclick="app.closeModal('modal-system')"></div>
        <div class="glass-panel w-[85%] max-w-sm rounded-[32px] p-8 relative z-10 animate-slide-up shadow-2xl bg-white/90">
            <h3 class="text-lg font-bold mb-8 text-center text-slate-800">ç³»ç»Ÿè®¾ç½®</h3>
            <div class="space-y-6">
                <div class="bg-white/50 p-5 rounded-[20px] border border-white/60 text-center">
                    <label class="text-[9px] font-bold text-slate-400 uppercase mb-2 block tracking-widest">æœˆåº¦é¢„ç®—é™é¢</label>
                    <input type="number" id="setting-budget" onchange="app.saveBudgetSetting()" placeholder="3000" class="w-full bg-transparent font-bold text-3xl text-center text-blue-600 border-b border-blue-100 pb-2 focus:border-blue-500 transition-colors">
                </div>
                <div class="space-y-3">
                    <button id="btn-generate" onclick="app.animateAndExport()" class="w-full bg-slate-800 text-white p-4 rounded-[18px] flex items-center justify-center gap-2 active:scale-95 transition-transform shadow-lg">
                        <i class="ph-fill ph-download-simple"></i>
                        <div class="word-swap font-bold text-sm"><span class="default-text">ä¸‹è½½å¤‡ä»½æ•°æ®</span><span class="generating-text hidden">æ­£åœ¨æ‰“åŒ…...</span></div>
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="app.exportCalendar()" class="bg-white p-3 rounded-[16px] text-xs font-bold border border-slate-200 hover:border-blue-300 active:scale-95 transition-all text-slate-600">å¯¼å‡ºæ—¥å†</button>
                        <button onclick="document.getElementById('file-input').click()" class="bg-white p-3 rounded-[16px] text-xs font-bold border border-slate-200 text-blue-600 hover:border-blue-300 active:scale-95 transition-all">æ¢å¤æ•°æ®</button>
                        <input type="file" id="file-input" hidden onchange="app.importData(this)">
                    </div>
                </div>
            </div>
            <button onclick="app.closeModal('modal-system')" class="mt-8 w-full py-3 text-slate-400 font-bold text-xs uppercase tracking-widest">å…³é—­</button>
        </div>
    </div>

    <div id="modal-purchase" class="modal fixed inset-0 z-[100] hidden items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/10 backdrop-blur-sm" onclick="app.closeModal('modal-purchase')"></div>
        <div class="glass-panel w-full sm:w-[400px] rounded-t-[32px] sm:rounded-[32px] p-8 z-10 animate-slide-up shadow-2xl bg-white/90">
            <h3 class="text-xl font-bold mb-8 text-center text-slate-800">ç¡®è®¤è´­å…¥</h3>
            <input type="hidden" id="pur-id">
            <div class="bg-white/50 rounded-[20px] p-2 mb-8 border border-white/60">
                <div class="grid grid-cols-2 divide-x divide-slate-100">
                    <div class="p-4 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase mb-2 block tracking-widest">å®é™…ä»·æ ¼</label>
                        <input type="number" id="pur-price" class="w-full bg-transparent font-bold text-xl text-slate-800 text-center">
                    </div>
                    <div class="p-4 text-center">
                        <label class="text-[9px] font-bold text-slate-400 uppercase mb-2 block tracking-widest">æ—¥æœŸ</label>
                        <input type="date" id="pur-date" class="w-full bg-transparent font-bold text-sm text-slate-600 text-center">
                    </div>
                </div>
            </div>
            <div id="pur-dynamic-fields" class="mb-6"></div>
            <button onclick="app.confirmPurchase()" class="w-full bg-emerald-500 text-white font-bold py-4 rounded-[18px] shadow-lg shadow-emerald-500/30 active:scale-95 transition-transform">ç¡®è®¤å…¥åº“</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('header-date').innerText = new Date().toLocaleDateString('zh-CN', {weekday:'long', month:'short', day:'numeric'});
    });

    const CATEGORY_TREE = { "é£Ÿå“": ["ç”Ÿé²œè”¬èœ", "è‚‰è›‹å¥¶", "é›¶é£Ÿé¥®æ–™", "ç²®æ²¹è°ƒå‘³", "ä¿å¥å“"], "æ—¥ç”¨å“": ["çº¸å“æ¹¿å·¾", "æ´—æŠ¤æ¸…æ´", "å¨æˆ¿å«æµ´", "æ”¶çº³æ•´ç†"], "å® ç‰©ç”¨å“": ["ä¸»ç²®", "é›¶é£Ÿ", "çŒ«ç ‚/å°¿å«", "ç©å…·/å‡ºè¡Œ", "åŒ»è¯/é©±è™«"], "æ•°ç å®¶ç”µ": ["æ‰‹æœºé…ä»¶", "ç”µè„‘åŠå…¬", "ç”Ÿæ´»ç”µå™¨", "å¤§å®¶ç”µ"], "æœé¥°é‹åŒ…": ["è¡£æœ", "é‹é´", "ç®±åŒ…", "é…é¥°"], "ç¾å¦†ä¸ªæŠ¤": ["æŠ¤è‚¤", "å½©å¦†", "èº«ä½“æŠ¤ç†", "é¦™æ°´"], "å®¶å±…è£…ä¿®": ["å®¶å…·", "ç¯å…·", "äº”é‡‘", "å®¶çºº"], "å…¶ä»–": ["é»˜è®¤"] };
    const COLORS = { "é£Ÿå“": "#fca5a5", "æ—¥ç”¨å“": "#93c5fd", "å® ç‰©ç”¨å“": "#fde047", "æ•°ç å®¶ç”µ": "#5eead4", "æœé¥°é‹åŒ…": "#d8b4fe", "ç¾å¦†ä¸ªæŠ¤": "#fdba74", "å®¶å±…è£…ä¿®": "#e2e8f0", "å…¶ä»–": "#cbd5e1" };

    const app = {
        data: { items: [], totalBudget: 0, customRules: {} },
        state: { statMode: 'month', statOffset: 0, currentTab: 'tobuy' },

        init() {
            this.loadData();
            this.renderCategoryOptions();
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
            this.renderToBuy();
            this.updateBannerDots();
        },

        handleImageUpload(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height; const maxSize = 800;
                    if (width > height && width > maxSize) { height *= maxSize / width; width = maxSize; }
                    else if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    document.getElementById('item-img-base64').value = compressedBase64;
                    document.getElementById('item-img-preview').src = compressedBase64;
                    document.getElementById('item-img-preview').classList.remove('hidden');
                    document.getElementById('item-img-placeholder').classList.add('hidden');
                    document.querySelector('.img-upload-box').classList.add('has-img');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        },

        createSecondaryBtn(text, onClick) {
            return `<button onclick="${onClick}" class="px-4 py-1.5 rounded-full text-[10px] font-bold text-blue-600 bg-blue-50 border border-blue-100 hover:bg-blue-100 transition-all flex items-center gap-1 active:scale-95"><span>${text}</span><i class="ph-bold ph-arrow-right"></i></button>`;
        },

        autoCategorize(name) {
            if (!name) return { main: "å…¶ä»–", sub: "é»˜è®¤" };
            if (this.data.customRules[name]) return this.data.customRules[name];
            const rules = [ { k: /çŒ«|ç‹—|å® |ç½å¤´/, m: "å® ç‰©ç”¨å“", s: "ä¸»ç²®" }, { k: /ç ‚|å°¿å«/, m: "å® ç‰©ç”¨å“", s: "çŒ«ç ‚/å°¿å«" }, { k: /çº¸|å·¾|åƒåœ¾/, m: "æ—¥ç”¨å“", s: "çº¸å“æ¹¿å·¾" }, { k: /æ´—å‘|æ²æµ´|ç‰™|æ´—è¡£/, m: "æ—¥ç”¨å“", s: "æ´—æŠ¤æ¸…æ´" }, { k: /èœ|è‚‰|è›‹|å¥¶|æœ/, m: "é£Ÿå“", s: "ç”Ÿé²œè”¬èœ" }, { k: /é›¶é£Ÿ|é¥¼å¹²|å·§å…‹åŠ›|æ°´|é¥®/, m: "é£Ÿå“", s: "é›¶é£Ÿé¥®æ–™" }, { k: /æœº|ç”µ|å……|çº¿/, m: "æ•°ç å®¶ç”µ", s: "æ‰‹æœºé…ä»¶" }, { k: /å¦†|æŠ¤è‚¤|é¢éœœ|å£çº¢/, m: "ç¾å¦†ä¸ªæŠ¤", s: "æŠ¤è‚¤" } ];
            for (let r of rules) { if (r.k.test(name)) return { main: r.m, sub: r.s }; }
            return { main: "å…¶ä»–", sub: "é»˜è®¤" };
        },
        autoCategorizeInput() {
            const name = document.getElementById('item-name').value; const res = this.autoCategorize(name);
            const mainSelect = document.getElementById('item-category');
            if (mainSelect.value === "" || document.getElementById('modal-title').innerText.includes("æ·»åŠ ")) {
                mainSelect.value = res.main; this.updateSubCategories(); document.getElementById('item-subcategory').value = res.sub;
            }
        },
        renderCategoryOptions() { document.getElementById('item-category').innerHTML = Object.keys(CATEGORY_TREE).map(k => `<option value="${k}">${k}</option>`).join(''); this.updateSubCategories(); },
        updateSubCategories() { const main = document.getElementById('item-category').value; document.getElementById('sub-options').innerHTML = (CATEGORY_TREE[main] || ["é»˜è®¤"]).map(s => `<option value="${s}"></option>`).join(''); },

        renderToBuy() {
            const list = document.getElementById('tobuy-list');
            const search = document.getElementById('search-input').value.toLowerCase();
            const sortMode = document.getElementById('sort-mode').value;
            let items = this.data.items.filter(i => !i.purchased).filter(i => (i.name + (i.category||"") + (i.platform||"") + (i.note||"")).toLowerCase().includes(search));
            items.forEach(i => { if(!i.priority) i.priority = 2; });
            items.sort((a, b) => {
                if (sortMode === 'priority') return a.priority - b.priority;
                if (sortMode === 'date') return new Date(a.deadline) - new Date(b.deadline);
                return (a.category||"").localeCompare(b.category||"");
            });

            const total = items.reduce((sum, i) => sum + (parseFloat(i.expectedPrice)||0), 0);
            document.getElementById('total-expected-cost').innerText = total;
            document.getElementById('count-p1').innerText = items.filter(i => i.priority == 1).length;
            document.getElementById('count-p2').innerText = items.filter(i => i.priority == 2).length;
            document.getElementById('count-p3').innerText = items.filter(i => i.priority == 3).length;
            const currentMonth = new Date().toISOString().substring(0, 7);
            const spent = this.data.items.filter(i => i.purchased && i.purchaseDate.startsWith(currentMonth)).reduce((sum, i) => sum + (parseFloat(i.actualPrice)||0), 0);
            const left = (this.data.totalBudget || 0) - spent - total;
            const leftEl = document.getElementById('budget-left');
            leftEl.innerText = `Â¥${left.toFixed(0)}`;
            leftEl.className = left < 0 ? 'text-red-500 font-bold' : 'text-blue-600 font-bold';

            // --- æ–°å¢ï¼šæ›´æ–°ç¬¬ä¸‰ä¸ª Banner (åˆ†ç±»ç»Ÿè®¡) ---
            const catCounts = {};
            items.forEach(i => { catCounts[i.category] = (catCounts[i.category] || 0) + 1; });
            const topCats = Object.entries(catCounts).sort((a,b) => b[1] - a[1]).slice(0, 3);
            const chartHtml = topCats.length ? topCats.map(([cat, count]) => {
                const pct = (count / items.length) * 100;
                const color = COLORS[cat] || '#cbd5e1';
                return `<div class="flex items-center gap-3 text-xs"><span class="w-12 truncate text-slate-500 font-medium">${cat}</span><div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div class="h-full rounded-full transition-all duration-500" style="width:${pct}%; background-color:${color}"></div></div><span class="font-bold text-slate-600 w-4 text-right">${count}</span></div>`;
            }).join('') : '<div class="text-center text-slate-300 text-xs py-4">æš‚æ— å¾…è´­æ•°æ®</div>';
            document.getElementById('banner-category-chart').innerHTML = chartHtml;
            // ------------------------------------------

            if (items.length === 0) { document.getElementById('empty-state').classList.replace('hidden', 'flex'); list.innerHTML = ''; }
            else {
                document.getElementById('empty-state').classList.replace('flex', 'hidden');
                list.innerHTML = items.map((item, index) => {
                    let days = 0; if(item.deadline) days = Math.ceil((new Date(item.deadline) - new Date()) / 86400000);
                    const dlClass = days <= 2 ? 'text-red-500 font-bold' : 'text-slate-400';
                    const dlText = days < 0 ? `é€¾æœŸ ${Math.abs(days)} å¤©` : `å‰© ${days} å¤©`;
                    const pClass = item.priority == 1 ? 'bg-red-400' : (item.priority == 2 ? 'bg-amber-400' : 'bg-emerald-400');
                    const imgHtml = item.image ? `<img src="${item.image}" class="w-14 h-14 rounded-2xl object-cover shadow-sm shrink-0">` : `<div class="w-14 h-14 rounded-2xl bg-white flex items-center justify-center shrink-0 border border-white/60 shadow-sm"><i class="ph-fill ph-shopping-bag text-blue-200 text-2xl"></i></div>`;
                    const linkHtml = item.link ? `<a href="${item.link}" target="_blank" class="w-6 h-6 flex items-center justify-center rounded-full bg-blue-50 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors" onclick="event.stopPropagation()"><i class="ph-bold ph-link text-xs"></i></a>` : '';
                    const noteHtml = item.note ? `<div class="text-[10px] text-slate-400 mt-1 truncate max-w-[150px] font-medium"><i class="ph ph-note-pencil mr-1"></i>${item.note}</div>` : '';

                    return `
                    <div class="glass-panel p-3 rounded-[24px] flex items-center justify-between group animate-slide-up hover:bg-white/80 transition-colors relative cursor-pointer" style="animation-delay: ${index * 50}ms" onclick="app.editItem('${item.id}')">
                        <div class="absolute top-2 left-2 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph-bold ph-pencil-simple"></i></div>
                        <div class="flex items-center gap-4 overflow-hidden pl-2">
                            ${imgHtml}
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <div class="w-1.5 h-1.5 rounded-full ${pClass} shadow-sm"></div>
                                    <h4 class="font-bold text-slate-700 truncate text-[15px]">${item.name}</h4>
                                    ${linkHtml}
                                </div>
                                <div class="flex flex-wrap gap-2 mt-1.5">
                                    <span class="text-[10px] bg-white text-slate-500 px-2 py-0.5 rounded-md border border-slate-100 font-semibold shadow-sm">${item.category}</span>
                                    <span class="text-[10px] ${dlClass} font-semibold flex items-center gap-1"><i class="ph-bold ph-clock"></i> ${dlText}</span>
                                </div>
                                ${noteHtml}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2 ml-2 shrink-0">
                            <span class="font-bold text-lg text-slate-800">Â¥${item.expectedPrice}</span>
                            ${this.createSecondaryBtn('è´­å…¥', `event.stopPropagation(); app.openPurchaseModal('${item.id}')`)}
                        </div>
                    </div>`;
                }).join('');
            }
        },

        renderPurchased() {
            const list = document.getElementById('purchased-list');
            const search = document.getElementById('pur-search-input').value.toLowerCase();
            const items = this.data.items.filter(i => i.purchased).filter(i => (i.name + i.category).toLowerCase().includes(search)).sort((a,b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));
            list.innerHTML = items.map(item => `
                <div class="glass-panel p-4 rounded-[20px] flex justify-between items-center opacity-80 hover:opacity-100 transition-opacity">
                    <div class="flex gap-4 items-center">
                        ${item.image ? `<img src="${item.image}" class="w-10 h-10 rounded-xl object-cover grayscale opacity-70">` : ''}
                        <div><div class="font-bold line-through text-slate-400">${item.name}</div><div class="text-[10px] font-bold text-slate-300 mt-0.5 uppercase tracking-wide">${item.purchaseDate}</div></div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-slate-700">Â¥${item.actualPrice}</div>
                        <div class="flex gap-2 mt-2"><button onclick="app.revertItem('${item.id}')" class="text-[10px] font-bold text-blue-400 hover:text-blue-600">æ’¤å›</button><button onclick="app.deleteItem('${item.id}')" class="text-[10px] font-bold text-red-400 hover:text-red-600">åˆ é™¤</button></div>
                    </div>
                </div>`).join('');
        },

        switchStatMode(mode, el) {
            this.state.statMode = mode; this.state.statOffset = 0;
            document.querySelectorAll('.stat-tab').forEach(e => { e.classList.remove('bg-white', 'text-blue-600', 'shadow-sm'); e.classList.add('text-slate-400'); });
            el.classList.remove('text-slate-400'); el.classList.add('bg-white', 'text-blue-600', 'shadow-sm');
            this.renderStats();
        },
        changeStatDate(dir) { this.state.statOffset += dir; this.renderStats(); },
        renderStats() {
            const mode = this.state.statMode; const offset = this.state.statOffset; let start, end, label; const now = new Date();
            if (mode === 'month') { const d = new Date(now.getFullYear(), now.getMonth() + offset, 1); start = new Date(d.getFullYear(), d.getMonth(), 1); end = new Date(d.getFullYear(), d.getMonth() + 1, 0); label = d.toLocaleDateString('zh-CN', {year:'numeric', month:'short'}); }
            else if (mode === 'year') { const y = now.getFullYear() + offset; start = new Date(y, 0, 1); end = new Date(y, 11, 31); label = `${y}å¹´`; }
            else { const d = new Date(now); d.setDate(d.getDate() + (offset * 7)); const day = d.getDay() || 7; start = new Date(d.setDate(d.getDate() - day + 1)); end = new Date(new Date(start).setDate(start.getDate() + 6)); label = `${start.getDate()}æ—¥ - ${end.getDate()}æ—¥`; }
            document.getElementById('stat-date-display').innerText = label;
            const rangeItems = this.data.items.filter(i => i.purchased && new Date(i.purchaseDate) >= start && new Date(i.purchaseDate) <= end);
            const total = rangeItems.reduce((sum, i) => sum + (parseFloat(i.actualPrice)||0), 0);
            document.getElementById('stat-total').innerText = total;
            const catMap = {}; rangeItems.forEach(i => catMap[i.category] = (catMap[i.category] || 0) + parseFloat(i.actualPrice));
            const container = document.getElementById('css-chart-area');
            if (Object.keys(catMap).length === 0) container.innerHTML = '<div class="text-center text-slate-300 py-4 text-xs font-bold uppercase tracking-widest">æš‚æ— æ•°æ®</div>';
            else {
                const sorted = Object.entries(catMap).sort((a,b) => b[1] - a[1]); const maxVal = sorted[0][1];
                container.innerHTML = sorted.map(([cat, val]) => {
                    const width = maxVal > 0 ? (val / maxVal * 100) : 0; const color = COLORS[cat] || COLORS['å…¶ä»–'];
                    return `<div class="flex items-center gap-3"><div class="w-16 text-[10px] text-slate-400 truncate text-right font-bold uppercase">${cat}</div><div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div class="h-full rounded-full shadow-sm" style="width: ${width}%; background-color: ${color}"></div></div><div class="w-12 text-[10px] font-bold text-right text-slate-600">Â¥${val}</div></div>`;
                }).join('');
            }
            const budget = this.data.totalBudget || 0; const pct = budget > 0 ? (total / budget * 100) : 0; const barColor = pct > 90 ? 'bg-red-400' : 'bg-emerald-400';
            document.getElementById('budget-display-area').innerHTML = `<div class="flex justify-between text-[10px] mb-2 text-slate-400 font-bold uppercase tracking-widest"><span>å·²ç”¨: Â¥${total}</span><span>é™é¢: Â¥${budget}</span></div><div class="h-2 bg-slate-100 rounded-full overflow-hidden"><div class="h-full ${barColor} transition-all duration-500 shadow-sm" style="width: ${Math.min(pct, 100)}%"></div></div>`;
        },

        saveItem() {
            const id = document.getElementById('item-id').value; const name = document.getElementById('item-name').value; if (!name) return alert('è¯·è¾“å…¥ç‰©å“åç§°');
            const catMain = document.getElementById('item-category').value; const catSub = document.getElementById('item-subcategory').value || "é»˜è®¤";
            const image = document.getElementById('item-img-base64').value; const link = document.getElementById('item-link').value; const note = document.getElementById('item-note').value;
            const autoRes = this.autoCategorize(name); if (autoRes.main !== catMain || autoRes.sub !== catSub) this.data.customRules[name] = { main: catMain, sub: catSub };
            const newItem = { id: id || Date.now().toString(), name, expectedPrice: parseFloat(document.getElementById('item-price').value) || 0, priority: parseInt(document.getElementById('item-priority').value), category: catMain, subCategory: catSub, platform: document.getElementById('item-platform').value, deadline: document.getElementById('item-deadline').value, image, link, note, purchased: false, ...((id && this.data.items.find(i => i.id === id)) || {}) };
            Object.assign(newItem, { name, category: catMain, subCategory: catSub, expectedPrice: newItem.expectedPrice, deadline: newItem.deadline, platform: newItem.platform, priority: newItem.priority, image, link, note });
            if (id) { this.data.items[this.data.items.findIndex(i => i.id === id)] = newItem; } else { this.data.items.push(newItem); }
            this.saveData(); this.closeModal('modal-item'); this.renderToBuy();
        },
        deleteItem(id) { if(confirm('ç¡®å®šåˆ é™¤å—ï¼Ÿ')) { this.data.items = this.data.items.filter(i => i.id !== id); this.saveData(); this.renderToBuy(); this.renderPurchased(); } },
        
        openAddModal() {
            document.getElementById('item-id').value = ''; document.getElementById('modal-title').innerText = 'æ·»åŠ ç‰©å“'; document.getElementById('item-category').value = 'å…¶ä»–'; document.getElementById('item-img-base64').value = ''; document.getElementById('item-img-preview').classList.add('hidden'); document.getElementById('item-img-placeholder').classList.remove('hidden'); document.querySelector('.img-upload-box').classList.remove('has-img'); document.getElementById('item-link').value = ''; document.getElementById('item-note').value = ''; this.updateSubCategories(); 
            document.getElementById('btn-delete-item').classList.add('hidden');
            this.openModal('modal-item');
        },

        deleteCurrentItem() {
            const id = document.getElementById('item-id').value;
            if(id && confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤æ­¤ç‰©å“å—ï¼Ÿ')) {
                this.data.items = this.data.items.filter(i => i.id !== id);
                this.saveData(); this.closeModal('modal-item'); this.renderToBuy();
            }
        },

        editItem(id) {
            const item = this.data.items.find(i => i.id === id); if (!item) return;
            document.getElementById('modal-title').innerText = 'ç¼–è¾‘ç‰©å“'; document.getElementById('item-id').value = item.id; document.getElementById('item-name').value = item.name; document.getElementById('item-price').value = item.expectedPrice; document.getElementById('item-deadline').value = item.deadline; document.getElementById('item-platform').value = item.platform; document.getElementById('item-priority').value = item.priority || 2; document.getElementById('item-link').value = item.link || ''; document.getElementById('item-note').value = item.note || '';
            const imgBox = document.querySelector('.img-upload-box');
            if (item.image) { document.getElementById('item-img-base64').value = item.image; document.getElementById('item-img-preview').src = item.image; document.getElementById('item-img-preview').classList.remove('hidden'); document.getElementById('item-img-placeholder').classList.add('hidden'); imgBox.classList.add('has-img'); } 
            else { document.getElementById('item-img-base64').value = ''; document.getElementById('item-img-preview').classList.add('hidden'); document.getElementById('item-img-placeholder').classList.remove('hidden'); imgBox.classList.remove('has-img'); }
            document.getElementById('item-category').value = item.category; this.updateSubCategories(); document.getElementById('item-subcategory').value = item.subCategory; 
            
            // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
            document.getElementById('btn-delete-item').classList.remove('hidden');
            this.openModal('modal-item');
        },
        openPurchaseModal(id) {
            const item = this.data.items.find(i => i.id === id); document.getElementById('pur-id').value = id; document.getElementById('pur-price').value = item.expectedPrice; document.getElementById('pur-date').valueAsDate = new Date();
            const isFood = ["é£Ÿå“", "è¯å“/ä¿å¥å“"].includes(item.category); document.getElementById('pur-dynamic-fields').innerHTML = isFood ? `<label class="text-[9px] font-bold text-slate-400 uppercase mb-1.5 block tracking-widest">è¿‡æœŸæ—¥æœŸ</label><input type="date" id="pur-expiry" class="w-full bg-transparent font-bold text-sm border-b border-slate-200">` : '';
            document.getElementById('modal-purchase').classList.remove('hidden'); document.getElementById('modal-purchase').classList.add('flex');
        },
        confirmPurchase() {
            const id = document.getElementById('pur-id').value; const item = this.data.items.find(i => i.id === id); item.purchased = true; item.actualPrice = parseFloat(document.getElementById('pur-price').value) || 0; item.purchaseDate = document.getElementById('pur-date').value;
            const expiryEl = document.getElementById('pur-expiry'); if (expiryEl) item.expiryDate = expiryEl.value; this.saveData(); this.closeModal('modal-purchase'); this.renderToBuy();
        },
        revertItem(id) { const item = this.data.items.find(i => i.id === id); item.purchased = false; this.saveData(); this.renderToBuy(); this.renderPurchased(); },
        animateAndExport() { const btn = document.getElementById('btn-generate'); const def = btn.querySelector('.default-text'); const gen = btn.querySelector('.generating-text'); const swap = btn.querySelector('.word-swap'); const icon = btn.querySelector('i'); def.classList.add('hidden'); gen.classList.remove('hidden'); swap.classList.add('generating'); icon.classList.add('animate-spin'); setTimeout(() => { this.exportData(); setTimeout(() => { def.classList.remove('hidden'); gen.classList.add('hidden'); swap.classList.remove('generating'); icon.classList.remove('animate-spin'); }, 1000); }, 1500); },
        exportCalendar() { let icsMsg = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//SmartShopping//CN\n"; this.data.items.filter(i => !i.purchased).forEach(i => { const dateStr = i.deadline.replace(/-/g, ''); icsMsg += `BEGIN:VEVENT\nSUMMARY:ğŸ›’Buy:${i.name}\nDTSTART;VALUE=DATE:${dateStr}\nDESCRIPTION:Budget:${i.expectedPrice}\nEND:VEVENT\n`; }); icsMsg += "END:VCALENDAR"; const blob = new Blob([icsMsg], { type: 'text/calendar' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `plan.ics`; a.click(); },
        exportData() { const blob = new Blob([JSON.stringify(this.data)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup.json'; a.click(); },
        importData(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { this.data = JSON.parse(e.target.result); this.saveData(); alert('Restored!'); location.reload(); } catch(err) { alert('Error file'); } }; reader.readAsText(file); },

        openModal(id) { const el = document.getElementById(id); el.classList.remove('hidden'); el.classList.add('flex'); },
        closeModal(id) { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); },
        openSystemModal() { document.getElementById('setting-budget').value = this.data.totalBudget || ''; app.openModal('modal-system'); },
        saveBudgetSetting() { this.data.totalBudget = parseFloat(document.getElementById('setting-budget').value) || 0; this.saveData(); this.renderToBuy(); },
        switchTab(tab, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); document.getElementById('view-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item i').forEach(i => { i.className = i.className.replace('text-blue-600', 'text-slate-400').replace('ph-fill', 'ph'); });
            document.querySelectorAll('.nav-item span').forEach(s => { s.className = s.className.replace('text-blue-600', 'text-slate-400'); });
            const icon = el.querySelector('i'); const text = el.querySelector('span'); 
            icon.className = icon.className.replace('text-slate-400', 'text-blue-600').replace('ph', 'ph-fill');
            text.className = text.className.replace('text-slate-400', 'text-blue-600');
            if (tab === 'stats') this.renderStats();
        },
        updateBannerDots() { const scroll = document.getElementById('banner-scroll').scrollLeft; const width = document.getElementById('banner-scroll').offsetWidth; const idx = Math.round(scroll / width); document.querySelectorAll('.dot').forEach((d, i) => { if(i===idx) { d.classList.add('bg-blue-400', 'w-4'); d.classList.remove('bg-blue-200'); } else { d.classList.remove('bg-blue-400', 'w-4'); d.classList.add('bg-blue-200'); } }); },
        saveData() { localStorage.setItem('smart_shopping_data', JSON.stringify(this.data)); },
        loadData() { const d = localStorage.getItem('smart_shopping_data'); if (d) this.data = JSON.parse(d); if (!this.data.customRules) this.data.customRules = {}; if (!this.data.items) this.data.items = []; }
    };
    app.init();
    </script>
</body>
</html>